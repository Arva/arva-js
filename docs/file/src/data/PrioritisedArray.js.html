<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/data/PrioritisedArray.js | Arva</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<link rel="stylesheet" href="./inject/css/0-styles.css"><meta name="description" content="this is awesome library"><meta property="og:type" content="website"><meta property="og:url" content="http://arva.io"><meta property="og:site_name" content="Arva"><meta property="og:title" content="Arva"><meta property="og:image" content="http://arva.io/img/logo-arva.png"><meta property="og:description" content="this is awesome library"><meta property="og:author" content="https://twitter.com/arvamazing"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Arva"><meta property="twitter:description" content="this is awesome library"><meta property="twitter:image" content="http://arva.io/img/logo-arva.png"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./" style="display: flex; align-items: center;"><img src="./image/brand_logo.png" style="width:34px;"></a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/Arva/arva-js"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#components">components</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/DataBoundScrollView.js~DataBoundScrollView.html">DataBoundScrollView</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/Dialog.js~Dialog.html">Dialog</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/components/ReflowingScrollView.js~ReflowingScrollView.html">ReflowingScrollView</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#core">core</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/App.js~App.html">App</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/Controller.js~Controller.html">Controller</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/Model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/Router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/ScrollController.js~ScrollController.html">ScrollController</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/core/View.js~View.html">View</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#data">data</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/PrioritisedArray.js~PrioritisedArray.html">PrioritisedArray</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#data-datasources-sharepoint-spsoapadapter">data/datasources/SharePoint/SPSoapAdapter</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SPSoapAdapter/Settings.js~Settings.html">Settings</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#data-datasources-sharepoint-spsoapadapter-worker">data/datasources/SharePoint/SPSoapAdapter/Worker</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/datasources/SharePoint/SPSoapAdapter/Worker/SharePointClient.js~SharePointClient.html">SharePointClient</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#data-local">data/local</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/local/LocalModel.js~LocalModel.html">LocalModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/data/local/LocalPrioritisedArray.js~LocalPrioritisedArray.html">LocalPrioritisedArray</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#layout">layout</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/layout/Decorators.js~Event.html">Event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/layout/Decorators.js~Flow.html">Flow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/layout/Decorators.js~Layout.html">Layout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createChainableDecorator">createChainableDecorator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-prepDecoratedRenderable">prepDecoratedRenderable</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-prepPrototypeDecorations">prepPrototypeDecorations</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-dynamic">dynamic</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-TrueSizedLayoutDockHelper">TrueSizedLayoutDockHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-decoratorTypes">decoratorTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-bindings">bindings</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-event">event</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-flow">flow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-layout">layout</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-flowStates">flowStates</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-StickTypes">StickTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-StickTypes">StickTypes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dockBottom">dockBottom</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dockLeft">dockLeft</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dockRight">dockRight</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-dockTop">dockTop</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-fill">fill</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#routers">routers</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/routers/ArvaRouter.js~ArvaRouter.html">ArvaRouter</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#surfaces">surfaces</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/surfaces/AudioSurface.js~AudioSurface.html">AudioSurface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/surfaces/Dropdown.js~Dropdown.html">Dropdown</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/surfaces/InputSurface.js~InputSurface.html">InputSurface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/surfaces/PushDownSurface.js~PushDownSurface.html">PushDownSurface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/surfaces/WebGLSurface.js~WebGLSurface.html">WebGLSurface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BgImageSurface">BgImageSurface</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Surface">Surface</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils">utils</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/BlobHelper.js~BlobHelper.html">BlobHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/DialogManager.js~DialogManager.html">DialogManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/Injection.js~Injection.html">Injection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/KeyboardHelper.js~KeyboardHelper.html">KeyboardHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/ObjectHelper.js~ObjectHelper.html">ObjectHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/Throttler.js~Throttler.html">Throttler</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-callbackToPromise">callbackToPromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-successAndErrorToPromise">successAndErrorToPromise</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-waitMilliseconds">waitMilliseconds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-combineOptions">combineOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-limit">limit</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Easing">Easing</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils-di">utils/di</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~ClassProvider.html">ClassProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~FactoryProvider.html">FactoryProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~Inject.html">Inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~Provide.html">Provide</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~SuperConstructor.html">SuperConstructor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Decorators.js~TransientScope.html">TransientScope</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/di/Injector.js~Injector.html">Injector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-annotate">annotate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-hasAnnotation">hasAnnotation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-inject">inject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-provide">provide</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-readAnnotations">readAnnotations</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-createProviderFromFnOrClass">createProviderFromFnOrClass</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isFunction">isFunction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isObject">isObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isUpperCase">isUpperCase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toString">toString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ownKeys">ownKeys</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils-dialog">utils/dialog</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/dialog/DialogWrapper.js~DialogWrapper.html">DialogWrapper</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils-hotfixes">utils/hotfixes</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-invalidateLayoutForElement">invalidateLayoutForElement</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils-request">utils/request</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ExistsRequest">ExistsRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GetRequest">GetRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PostRequest">PostRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UrlParser">UrlParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ParseStringToXml">ParseStringToXml</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#utils-view">utils/view</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/ArrayObserver.js~ArrayObserver.html">ArrayObserver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/ArrayObserver.js~MappedArray.html">MappedArray</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/InputOption.js~InputOption.html">InputOption</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~BaseLayoutHelper.html">BaseLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~DockedLayoutHelper.html">DockedLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~FullSizeLayoutHelper.html">FullSizeLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LayoutHelpers.js~TraditionalLayoutHelper.html">TraditionalLayoutHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/LazyLoadedOptionClone.js~LazyLoadedOptionClone.html">LazyLoadedOptionClone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/OptionObserver.js~OptionObserver.html">OptionObserver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/RenderableHelper.js~RenderableHelper.html">RenderableHelper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/SizeResolver.js~SizeResolver.html">SizeResolver</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/utils/view/Utils.js~Utils.html">Utils</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-changeValue">changeValue</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-onOptionChange">onOptionChange</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/data/PrioritisedArray.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**



 @author: Tom Clement (tjclement)
 @license NPOSL-3.0
 @copyright Bizboard, 2015

 */

import extend                       from &apos;lodash/extend.js&apos;;
import EventEmitter                 from &apos;eventemitter3&apos;;
import {DataSource}                 from &apos;./DataSource.js&apos;;
import {Model}                      from &apos;../core/Model.js&apos;;
import {LocalModel}                 from &apos;./local/LocalModel.js&apos;;
import {Injection}                  from &apos;../utils/Injection.js&apos;;
import {Throttler}                  from &apos;../utils/Throttler.js&apos;;
import {ObjectHelper}               from &apos;../utils/ObjectHelper.js&apos;;

/**
 * An array of two-way bound data Models that are automatically synced with the currently used DataSource
 */
export class PrioritisedArray {

  _children = [];
  _referenceLength = 0;
  /* The amount of numerical properties on this PrioArray that refer to this._children */
  get length() {
    return this._children.length;
  }

  /**
   *
   * @param {Function} dataType DataType of the models being added to the PrioritisedArray.
   * @param {DataSource} [dataSource] dataSource to load the models from. If none is given, a new DataSource is made with a path guessed from
   * the model&apos;s DataType name.
   * @param {Snapshot} [dataSnapshot] snapshot already containing model data. Prevents initial subscription on all values in the DataSource.
   * @param {Object} [options] options to pass to the dataSource if none is provided and a new one is constructed.
   * @param {Object} [modelOptions] options to merge into the construction of every new Model.
   * @returns {PrioritisedArray} PrioritisedArray instance.
   */
  constructor(dataType, dataSource = null, dataSnapshot = null, options = {}, modelOptions = {}) {
    /**** Callbacks ****/
    this._valueChangedCallback = null;

    options = options || {};


    /**** Private properties ****/
    this._ids = {};
    this._dataType = dataType;
    this._dataSource = dataSource;
    this._isBeingReordered = false;
    this._modelOptions = modelOptions;
    /* Flag to determine when we&apos;re reordering so we don&apos;t listen to move updates */
    this._eventEmitter = new EventEmitter();
    this._childAddedThrottler = new Throttler(options.noThrottle || typeof window === &apos;undefined&apos; ? 0 : 1, true, this, true);
    this._overrideChildAddedForId = null;

    /* We do the bindAllMethods before this happens in order to make sure that dataType.prototype isn&apos;t modified so
     * that this check would break
     */
    if (dataType &amp;&amp; !(dataType.prototype instanceof Model)) {
      throw new Error(`${dataType.toString()} passed to PrioritisedArray is not an instance of a model`);
    }

    /* Hide all private properties (starting with &apos;_&apos;) and methods from enumeration,
     * so when you do for( in ), only actual data properties show up. */
    ObjectHelper.hideMethodsAndPrivatePropertiesFromObject(this);

    /* Hide the priority field from enumeration, so we don&apos;t save it to the dataSource. */
    // ObjectHelper.hidePropertyFromObject(Object.getPrototypeOf(this), &apos;length&apos;);

    /* If no dataSource is given, create own one with guessed path */
    if (!dataSource) {
      /* The this._name property can be set by Arva&apos;s babel-plugin-transform-runtime-constructor-name plugin.
       * This allows Arva code to be minified and mangled without losing automated model name resolving.
       * If the plugin is not set up to run, which is done e.g. when not minifying your code, we default back to the runtime constructor name. */
      let path = this.constructor._name || Object.getPrototypeOf(this).constructor.name;
      /* Retrieve dataSource from the DI context */
      dataSource = Injection.get(DataSource);
      dataSource = dataSource.child(options.path || path, options);

      this._dataSource = dataSource;
    }

    /* If a snapshot is present use it, otherwise generate one by subscribing to the dataSource one time. */
    if (dataSnapshot) {
      this._buildFromSnapshot(dataSnapshot);
    } else {
      this._buildFromDataSource(dataSource);
    }
  }




  /**
   * Subscribes to events emitted by this PrioritisedArray.
   * @param {String} event One of the following Event Types: &apos;value&apos;, &apos;child_changed&apos;, &apos;child_moved&apos;, &apos;child_removed&apos;.
   * @param {Function} handler Function that is called when the given event type is emitted.
   * @param {Object} context Optional: context of &apos;this&apos; inside the handler function when it is called.
   * @returns {void}
   */
  on(event, handler, context) {
    /* If we&apos;re already ready, fire immediately */
    if ((event === &apos;ready&apos; || event === &apos;value&apos;) &amp;&amp; this._dataSource &amp;&amp; this._dataSource.ready) {
      handler.call(context, this);
    }

    /* If we already have children stored locally when the subscriber calls this method,
     * fire their callback for all pre-existing children. */
    if (event === &apos;child_added&apos;) {

      for (let i = 0; i &lt; this.length; i++) {
        this._childAddedThrottler.add(() =&gt; {
          let model = this._children[i];
          let previousSiblingID = i &gt; 0 ? this._children[i - 1].id : null;
          handler.call(context, model, previousSiblingID);
        });
      }
    }

    this._eventEmitter.on(event, handler, context);
  }

  /**
   * Subscribes to the given event type exactly once; it automatically unsubscribes after the first time it is triggered.
   * @param {String} event One of the following Event Types: &apos;value&apos;, &apos;child_changed&apos;, &apos;child_moved&apos;, &apos;child_removed&apos;.
   * @param {Function} [handler] Function that is called when the given event type is emitted.
   * @param {Object} [context] context of &apos;this&apos; inside the handler function when it is called.
   * @returns {Promise} A promise that resolves once the event has happened
   */
  once(event, handler, context = this) {
    return new Promise((resolve) =&gt; {
      this.on(event, function onceWrapper() {
        this.off(event, onceWrapper, context);
        handler &amp;&amp; handler.call(context, ...arguments);
        resolve(...arguments);
      }, this);
    });

  }

  /**
   * Removes subscription to events emitted by this PrioritisedArray. If no handler or context is given, all handlers for
   * the given event are removed. If no parameters are given at all, all event types will have their handlers removed.
   * @param {String} event One of the following Event Types: &apos;value&apos;, &apos;child_changed&apos;, &apos;child_moved&apos;, &apos;child_removed&apos;.
   * @param {Function} handler Function to remove from event callbacks.
   * @param {Object} context Object to bind the given callback function to.
   * @returns {void}
   */
  off(event, handler, context) {
    if (event &amp;&amp; (handler || context)) {
      this._eventEmitter.removeListener(event, handler, context);
    } else {
      this._eventEmitter.removeAllListeners(event);
    }
  }

  /**
   * Adds a model instance to the rear of the PrioritisedArray, and emits a &apos;child_added&apos; and possibly &apos;new_child&apos; event after successful addition.
   * @param {Model|Object} model Instance of a Model.
   * @param {String|undefined} prevSiblingId ID of the model preceding the one that will be added.
   * @param {Boolean} [emitValueEvent] Set to false to prevent emitting value event in this method.
   * @returns {Object} Same model as the one originally passed as parameter.
   */
  add(model, prevSiblingId = null, emitValueEvent = true) {
    if (model instanceof this._dataType) {
      if (this.findIndexById(model.id) &lt; 0) {

        if (prevSiblingId) {
          let newPosition = this.findIndexById(prevSiblingId) + 1;
          this.insertAt(model, newPosition);
        } else {
          this.push(model);
        }

        /* If we&apos;ve already received an on(&apos;value&apos;) result, this child addition is
         * a new entry that wasn&apos;t on the dataSource before. */
        if (this._dataSource.ready) {
          this._eventEmitter.emit(&apos;new_child&apos;, model, prevSiblingId);
        }

        this._eventEmitter.emit(&apos;child_added&apos;, model, prevSiblingId);
        if (emitValueEvent) {
          this._eventEmitter.emit(&apos;value&apos;, this);
        }

        return model;
      }
    } else if (model instanceof Object) {
      /* Let&apos;s try to parse the object using property reflection */
      var options = { dataSource: this._dataSource };
      /* Prevent child_added from being fired immediately when the model is created by creating a promise that resolves
       * the ID that shouldn&apos;t be synced twice
       */

      this._overrideChildAddedForId = this.once(&apos;local_child_added&apos;);
      let newModel = new this._dataType(null, model, extend({}, this._modelOptions, options));

      this.add(newModel, undefined, emitValueEvent);
      /* Remove lock */
      this._eventEmitter.emit(&apos;local_child_added&apos;, newModel);
      this._overrideChildAddedForId = null;
      return newModel;
    } else {
      /* TODO: change to throw exception */
      console.log(&apos;Tried to append an object that is not the same type as the one this PrioritisedArray was created with.&apos;);
    }

    /* Return model so we can do this: let newModel = PrioArray.add(new Model()); newModel.someProperty = true; */
    return null;
  }


  /**
   * Inserts a model instance at the given position of the PrioritisedArray, and recalculates the priority (position)
   * of all models after the inserted position.
   * @param {Model} model Subclass of Model
   * @param {Number} position Zero-based index where to put the new model instance.
   * @returns {Object} Same model as the one originally passed as parameter.
   */
  insertAt(model, position) {
    if (model instanceof this._dataType) {
      for (let i = position; i &lt; this.length; i++) {
        /* Increase the index of items further on in the prio array */
        this._ids[this._children[i].id]++;
      }
      this._children.splice(position, 0, model);
      this._ids[model._id] = position;
    } else {
      /* TODO: change to throw exception */
      console.log(&apos;Tried to append an object that is not the same type as the PrioritisedArray was created with.&apos;);
    }

    this._updateReferenceProperties();

    /* Return model so we can do this: let newModel = PrioArray.add(new Model()); newModel.someProperty = true; */
    return model;
  }

  /**
   * Adds a model or object to the end of the list.
   * @param {Object|Model} model
   * @returns {Model} The newly inserted model
   */
  push(model) {
    return this.insertAt(model, this.length);
  }

  /**
   * Removes the model instance at the given position. Does not remove the model from the datasource, to do that
   * call model.remove() directly, or PrioArray[index].remove().
   * @param {Number} position Index in the PrioritisedArray of the model to remove.
   * @returns {void}
   */
  remove(position) {
    /*
     * TODO: Beware, there might be hard to reproduce prone to errors going on sometimes when deleting many things at once
     * Sometimes, there is an inconsistent state, but I haven&apos;t been able to figure out how that happens. /Karl
     */
    if (this.length === 1) {
      this._ids = {};
    } else {
      for (let i = position + 1; i &lt; this.length; i++) {
        /* Decrease the index of items further on in the prio array */
        if (!this._ids[this._children[i].id] &amp;&amp; this._ids[this._children[i].id] !== 0) {
          console.log(&quot;Internal error, decreasing index of non-existing id. For ID: &quot; + this._children[i].id);
        }
        this._ids[this._children[i].id]--;
      }
      delete this._ids[this._children[position].id];

    }
    this.splice(position, 1);
    this._updateReferenceProperties();
  }


  /**
   * Return the position of model&apos;s id, saved in an associative array
   * @param {String} id Id field of the model we&apos;re looking for
   * @returns {Number} Zero-based index if found, -1 otherwise
   */
  findIndexById(id) {
    let position = this._ids[id];
    return (position == undefined || position == null) ? -1 : position;
  }


  /**
   * Finds an item based on its Id in the datasource.
   * @param id
   * @returns {Model}
   */
  findById(id) {
    return this._children[this.findIndexById(id)];
  }

  getDataSourcePath() {
    return this._dataSource.path();
  }

  /**
   * Replaces all items in this PrioritisedArray with items from newContents.
   * @param {PrioritisedArray} newContents PrioritisedArray to take elements from.
   */
  replaceContents(newContents) {
    while (this.length) {
      this._children[0].remove();
    }
    this._referenceLength = 0;
    for (let item of newContents) {
      this.add(LocalModel.cloneModelProperties(item));
    }
  }

  /**
   * Proxies PrioArray.find() to its underlying Array cache.
   * @returns {*}
   */
  find() {
    return this._children.find.apply(this._children, arguments);
  }
  /**
   * Proxies PrioArray.findIndex() to its underlying Array cache.
   * @returns {*}
   */
  findIndex() {
    return this._children.findIndex.apply(this._children, arguments);
  }
  /**
   * Proxies PrioArray.keys() to its underlying Array cache.
   * @returns {*}
   */
  keys() {
    return this._children.keys.apply(this._children, arguments);
  }
  /**
   * Proxies PrioArray.keys() to its underlying Array cache.
   * @returns {*}
   */
  includes() {
    return this._children.includes.apply(this._children, arguments);
  }

  /**
   * Proxies PrioArray.entries() to its underlying Array cache.
   * @returns {*}
   */
  entries() {
    return this._children.entries.apply(this._children, arguments);
  }

  /**
   * Proxies PrioArray.reduce() to its underlying Array cache.
   * @returns {*}
   */
  reduce() {
    return this._children.reduce.apply(this._children, arguments);
  }

  /**
   * Proxies PrioArray.map() to its underlying Array cache.
   * @returns {*}
   */
  map() {
    return this._children.map.apply(this._children, arguments);
  }

  /**
   * //TODO Why is this necessary? Would be better never to access this method
   * Proxies PrioArray.splice() to its underlying Array cache.
   * @returns {*}
   */
  splice() {
    let result = this._children.splice.apply(this._children, arguments);
    this._updateReferenceProperties();
    return result;
  }

  /**
   * Proxies PrioArray.filter() to its underlying Array cache.
   * @returns {*}
   */
  filter() {
    return this._children.filter.apply(this._children, arguments);
  }

  /**
   * Proxies PrioArray.concat() to its underlying Array cache.
   * @returns {*}
   */
  concat() {
      for(let index in arguments){
          if(arguments[index] instanceof PrioritisedArray){
              arguments[index] = arguments[index]._children;
          }
      }
      return this._children.concat.apply(this._children, arguments);
  }

  /**
   * Proxies PrioArray.every() to its underlying Array cache.
   * @returns {*}
   */
  every() {
    return this._children.every.apply(this._children, arguments);
  }
  /**
   * Proxies PrioArray.filter() to its underlying Array cache.
   * @returns {*}
   */
  includes() {
    return this._children.includes.apply(this._children, arguments);
  }
  /**
   * Proxies PrioArray.join() to its underlying Array cache.
   * @returns {*}
   */
  join() {
    return this._children.join.apply(this._children, arguments);
  }
  /**
   * Proxies PrioArray.lastIndexOf() to its underlying Array cache.
   * @returns {*}
   */
  lastIndexOf() {
    return this._children.lastIndexOf.apply(this._children, arguments);
  }
  /**
   * Proxies PrioArray.reduceRight() to its underlying Array cache.
   * @returns {*}
   */
  reduceRight() {
    return this._children.reduceRight.apply(this._children, arguments);
  }
  /**
   * Proxies PrioArray.some() to its underlying Array cache.
   * @returns {*}
   */
  some() {
    return this._children.some.apply(this._children, arguments);
  }


  /**
   * Allows &apos;for of&apos; loops on the PrioArray.
   */
  *[Symbol.iterator]() {
    for (let child of this._children) {
      yield child;
    }
  }

  /**
   * Whenever this PrioArray is typecasted, its underlying Array cache is returned.
   * @param hint
   * @returns {Array}
   */
  [Symbol.toPrimitive](hint) {
    return &quot;&quot; + this._children;
  }

  /**
   * Interprets all childs of a given snapshot as instances of the given data type for this PrioritisedArray,
   * and attempts to instantiate new model instances based on these sub-snapshots. It adds them to the
   * PrioritisedArray, which also assigns their priority based on their inserted position.
   * @param {Snapshot} dataSnapshot Snapshot to build the PrioritisedArray from.
   * @returns {void}
   * @private
   */
  _buildFromSnapshot(dataSnapshot) {

    let numChildren = dataSnapshot.numChildren(), currentChild = 1;

    /* If there is no data at this point yet, fire a ready event */
    if (numChildren === 0) {
      this._dataSource.ready = true;
      this._eventEmitter.emit(&apos;ready&apos;);
      this._eventEmitter.emit(&apos;value&apos;, this);
    }

    dataSnapshot.forEach(function (child) {
      this._childAddedThrottler.add(function (child) {
        /* Create a new instance of the given data type and prefill it with the snapshot data. */
        let options = { dataSnapshot: child, noInitialSync: true };
        let childRef = this._dataSource.child(child.key);

        /* whenever the ref() is a datasource, we can bind that source to the model.
         * whenever it&apos;s not a datasource, we assume the model should instantiate a new
         * datasource to bind the model */

        if (childRef instanceof DataSource) {
          options.dataSource = childRef;
        } else {
          var rootPath = dataSnapshot.ref().root().toString();
          options.path = dataSnapshot.ref().toString().replace(rootPath, &apos;/&apos;);
        }

        let newModel = new this._dataType(child.key, child.val(), extend({}, this._modelOptions, options));
        this.add(newModel, undefined, false);

        /* If this is the last child, fire a ready event */
        if (currentChild++ === numChildren) {
          this._dataSource.ready = true;
          this._eventEmitter.emit(&apos;ready&apos;);
          this._eventEmitter.emit(&apos;value&apos;, this);
        }

      }.bind(this, child));
    }.bind(this))
  }

  /**
   * Clones a dataSource (to not disturb any existing callbacks defined on the original) and uses it
   * to get a dataSnapshot which is used in _buildSnapshot to build our array.
   * @param {DataSource} dataSource DataSource to subscribe to for building the PrioritisedArray.
   * @returns {void}
   * @private
   */
  _buildFromDataSource(dataSource) {
    dataSource.once(&apos;value&apos;, (dataSnapshot) =&gt; {
      this._buildFromSnapshot(dataSnapshot);
      this._registerCallbacks(dataSource);
    });
  }

  /**
   * Registers the added, moved, changed, and removed callbacks to the given DataSource.
   * @param {DataSource} dataSource DataSource to register callbacks on.
   * @return {void}
   * @private
   */
  _registerCallbacks(dataSource) {
    dataSource.on(&apos;child_added&apos;, this._doOnceReady(this._onChildAdded));
    dataSource.on(&apos;child_moved&apos;, this._doOnceReady(this._onChildMoved));
    dataSource.on(&apos;child_changed&apos;, this._doOnceReady(this._onChildChanged));
    dataSource.on(&apos;child_removed&apos;, this._doOnceReady(this._onChildRemoved));
  }

  _doOnceReady(callback) {
    return (...otherArgs) =&gt; {
      if (!this._dataSource.ready) {
        this.once(&apos;ready&apos;, () =&gt; {
          return callback.call(this, ...otherArgs)
        });
      } else {
        return callback.call(this, ...otherArgs)
      }
    }
  }

  /**
   * Called by dataSource when a new child is added.
   * @param {Snapshot} snapshot Snapshot of the added child.
   * @param {String} prevSiblingId ID of the model preceding the added model.
   * @returns {void}
   * @private
   */
  _onChildAdded(snapshot, prevSiblingId) {
    let id = snapshot.key;
    if (this._overrideChildAddedForId) {
      this._overrideChildAddedForId.then((newModel) =&gt; {
        /* If the override is concerning another id, then go ahead and make the _onChildAdded */
        if (newModel.id !== id) {
          this._onChildAdded(snapshot, prevSiblingId)
        } else {
          this._eventEmitter.emit(&apos;value&apos;, this);
        }
        /* Otherwise, don&apos;t recreate the same model twice */
      });

      return;
    }

    /* Skip addition if an item with identical ID already exists. */
    let previousPosition = this.findIndexById(id);
    if (previousPosition &gt;= 0) {
      return;
    }

    let model = new this._dataType(id, null, extend({}, this._modelOptions, {
      noInitialSync: true,
      dataSnapshot: snapshot
    }));
    this.add(model, prevSiblingId, false);

    if (!this._dataSource.ready) {
      this._dataSource.ready = true;
      this._eventEmitter.emit(&apos;ready&apos;);
    }
    this._eventEmitter.emit(&apos;value&apos;, this);
  }

  /**
   * Called by dataSource when a child is changed.
   * @param {Snapshot} snapshot Snapshot of the added child.
   * @param {String} prevSiblingId ID of the model preceding the added model.
   * @returns {void}
   * @private
   */
  _onChildChanged(snapshot, prevSiblingId) {
    let id = snapshot.key;

    let previousPosition = this.findIndexById(id);
    if (previousPosition &lt; 0) {
      /* The model doesn&apos;t exist, so we won&apos;t emit a changed event. */
      return;
    }


    let model = this._children[previousPosition];
    model._onChildValue(snapshot, prevSiblingId);
    let newPosition = this.findIndexById(prevSiblingId) + 1;

    this._moveItem(previousPosition, newPosition, model);

    this._eventEmitter.emit(&apos;child_changed&apos;, model, prevSiblingId);
    this._eventEmitter.emit(&apos;value&apos;, this);
  }

  /**
   * Called by dataSource when a child is moved, which changes its priority.
   * @param {Snapshot} snapshot Snapshot of the added child.
   * @param {String} prevSiblingId ID of the model preceding the added model.
   * @returns {void}
   * @private
   */
  _onChildMoved(snapshot, prevSiblingId) {
    /* Ignore priority updates whilst we&apos;re reordering to avoid floods */
    if (!this._isBeingReordered) {

      let id = snapshot.key;
      let previousPosition = this.findIndexById(id);
      let newPosition = this.findIndexById(prevSiblingId) + 1;
      let tempModel = this._children[previousPosition];
      this._moveItem(previousPosition, newPosition, tempModel);

      let model = this._children[newPosition];

      this._eventEmitter.emit(&apos;child_moved&apos;, model, previousPosition);
      this._eventEmitter.emit(&apos;value&apos;, this);
    }
  }

  _moveItem(previousPosition, newPosition, modelToMove) {
    this._ids[modelToMove._id] = newPosition;
    /* Update the positions of things coming inbetween */
    for (let positionAhead = previousPosition; positionAhead &lt; newPosition; positionAhead++) {
      this._ids[this._children[positionAhead].id]--;
    }
    for (let positionBefore = newPosition; positionBefore &lt; previousPosition; positionBefore++) {
      this._ids[this._children[positionBefore].id]++;
    }

    if (previousPosition === newPosition) {
      this._children[newPosition] = modelToMove;
    } else {
      this._children.splice(previousPosition, 1);
      this._children.splice(newPosition, 0, modelToMove);
    }
  }

  /**
   * Called by dataSource when a child is removed.
   * @param {Snapshot} oldSnapshot Snapshot of the added child.
   * @returns {void}
   * @private
   */
  _onChildRemoved(oldSnapshot) {
    /* TODO: figure out if we can use the snapshot&apos;s priority as our array index reliably, to avoid big loops. */
    let id = oldSnapshot.key;
    let position = this.findIndexById(id);
    let model = this._children[position];

    if (position !== -1) {
      this.remove(position);
      delete this._ids[id];

      this._eventEmitter.emit(&apos;child_removed&apos;, model);
      this._eventEmitter.emit(&apos;value&apos;, this);
    }
  }

  /**
   * Updates the local properties [0]...[n] on this PrioArray instance, each of which is a getter to
   * the entry in the underlying Array cache at the same index.
   * @private
   */
  _updateReferenceProperties() {
    let wantedLength = this.length;
    let currentLength = this._referenceLength;
    let difference = wantedLength - currentLength;

    if (difference &gt; 0) {
      for (let i = 0; i &lt; difference; i++) {
        Object.defineProperty(this, `${currentLength + i}`, {
          get: () =&gt; this._children[currentLength + i],
          configurable: true,
          enumerable: true
        });
      }
    } else if (difference &lt; 0) {
      for (let i = 0; i &lt; (difference * -1); i++) {
        delete this[currentLength - 1 - i];
      }
    }

    this._referenceLength = this.length;
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
